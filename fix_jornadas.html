<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Reparaci贸n COMPLETA Maulas</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- App Scripts -->
    <script src="js/firebase-init.js"></script>
    <script src="js/db-service.js"></script>
    <script src="js/data_loader.js"></script>
    <script src="js/cloud-seeder.js"></script>
</head>

<body style="font-family: sans-serif; padding: 50px; text-align: center; background-color: #f5f5f5;">
    <div
        style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto;">
        <h1 style="color: #d32f2f;">REPARACIN TOTAL DEL SISTEMA</h1>
        <p>Esta herramienta va a:</p>
        <ul style="text-align: left; display: inline-block;">
            <li>1. Recargar <strong>TODAS</strong> las Jornadas (partidos y resultados) de la base de c贸digo.</li>
            <li>2. Recargar <strong>TODOS</strong> los Pron贸sticos hist贸ricos de todos los socios.</li>
        </ul>
        <br><br>
        <button id="btn-fix"
            style="font-size: 20px; padding: 20px 40px; cursor: pointer; background: #d32f2f; color: white; border: none; border-radius: 8px; font-weight: bold;">
             EJECUTAR CARGA COMPLETA
        </button>
        <div id="log"
            style="margin-top: 30px; text-align: left; background: #333; color: #0f0; padding: 20px; height: 300px; overflow: auto; font-family: monospace; border-radius: 5px;">
        </div>
    </div>

    <script>
        const btn = document.getElementById('btn-fix');
        const logDiv = document.getElementById('log');

        function log(msg) {
            logDiv.innerHTML += `<div>> ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        btn.addEventListener('click', async () => {
            btn.disabled = true;
            btn.style.opacity = "0.5";
            btn.innerText = "PROCESANDO...";
            log("INICIANDO PROCESO DE REPARACIN TOTAL...");

            try {
                // Initialize DB
                if (!window.DataService) {
                    await new Promise(r => setTimeout(r, 1000));
                }
                await window.DataService.init();
                log("Conexi贸n a Firebase: OK");

                // Check dependencies
                if (!window.CloudSeeder) throw new Error("CloudSeeder no cargado");
                if (!window.HISTORICAL_DATA) throw new Error("HISTORICAL_DATA no cargado");
                log("Scripts de datos: OK");

                // 1. RE-SEED JORNADAS (Matches & Results)
                log("--- FASE 1: JORNADAS ---");
                await window.CloudSeeder.seedJornadas(window.DataService);
                log("Jornadas actualizadas correctamente.");

                // 2. RE-SEED PRONOSTICOS (All of them)
                log("--- FASE 2: PRONSTICOS ---");
                let count = 0;
                for (const hData of window.HISTORICAL_DATA) {
                    const jNum = hData.jornada_num;
                    log(`Procesando Jornada ${jNum}...`);

                    if (hData.predictions) {
                        for (const [mId, preds] of Object.entries(hData.predictions)) {
                            if (preds) {
                                const record = {
                                    id: `${jNum}_${mId}`,
                                    jId: parseInt(jNum),
                                    mId: parseInt(mId),
                                    selection: preds,
                                    timestamp: new Date().toISOString(),
                                    repaired: true
                                };
                                // Force save
                                await window.DataService.save('pronosticos', record);
                                count++;
                            }
                        }
                    }
                }

                log(`--- FIN ---`);
                log(`Total pron贸sticos procesados: ${count}`);

                btn.innerText = "隆PROCESO COMPLETADO!";
                btn.style.background = "#388e3c";

                setTimeout(() => {
                    if (confirm("Reparaci贸n completada con 茅xito. 驴Ir al Dashboard?")) {
                        window.location.href = "index.html";
                    }
                }, 1000);

            } catch (e) {
                console.error(e);
                log("ERROR CRTICO: " + e.message);
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.innerText = "REINTENTAR";
            }
        });
    </script>
</body>

</html>